<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>{% block title %}Tienda Online{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="/static/style.css" rel="stylesheet">
    <script defer src="/static/js/cambio-precio.js"></script>
    <script defer src="/static/js/busqueda-header.js"></script>
    <script defer src="/static/js/busqueda.js"></script>



</head>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const toggles = document.querySelectorAll("[data-bs-toggle='collapse']");
        toggles.forEach(btn => {
            const icon = btn.querySelector(".toggle-icon");
            const targetId = btn.getAttribute("data-bs-target");
            const target = document.querySelector(targetId);

            if (!icon || !target) return;

            target.addEventListener("show.bs.collapse", () => {
                icon.textContent = "−";
            });
            target.addEventListener("hide.bs.collapse", () => {
                icon.textContent = "+";
            });
        });
    });
</script>

<body>
    <!-- CABECERA -->
    <header class="header shadow-sm">
        <div class="container d-flex align-items-center justify-content-between py-2">

            <!-- LOGO -->
            <div class="header__logo">
                <a href="/">
                    <img src="/static/logo.png" alt="Mi Tienda Online" height="40">
                </a>
            </div>

            <!-- BUSCADOR -->
            <form id="form-busqueda" class="header__search flex-grow-1 mx-4 position-relative" autocomplete="off">
                <div class="input-group">
                    <span class="input-group-text search-icon"><i class="bi bi-search"></i></span>
                    <input id="buscador" type="search" class="form-control search-input" placeholder="Buscar…">

                </div>

                <!-- Dropdown de búsqueda anticipada --
                <div id="search-dropdown" class="d-none position-absolute bg-white border rounded shadow"
                    style="top: 100%; left: 0; width:100%; z-index: 500;">
                </div>
                    -->
            </form>


            <!-- NAVEGACIÓN -->
            <nav class="header__nav d-flex align-items-center">

                <a href="/categorias" class="nav-link">Categorías</a>

                {% if usuario %}
                <a href="/usuarios/logout" class="nav-link fw-bold text-danger">
                    Cerrar sesión {{ usuario }}
                </a>
                {% else %}
                <a href="/usuarios/login" class="nav-link fw-bold">
                    Identifícate
                </a>
                {% endif %}

                <!-- CARRITO -->
                {% if session.carrito and session.carrito.length > 0 %}
                <button class="carrito-box d-flex align-items-center" type="button" data-bs-toggle="offcanvas"
                    data-bs-target="#offcanvasCarrito" aria-controls="offcanvasCarrito">

                    <i class="bi bi-cart3 me-2"></i>
                    <span class="badge bg-brown me-2">{{ session.carrito.length }}</span>
                    <span class="carrito-total">
                        {{ session.carrito | sum('precio_rebajado', 'precio_euros') }} €
                    </span>
                </button>

                {% else %}

                <button class="carrito-box-empty d-flex align-items-center" type="button" data-bs-toggle="offcanvas"
                    data-bs-target="#offcanvasCarrito" aria-controls="offcanvasCarrito">

                    <i class="bi bi-cart3 fs-5"></i>
                </button>

                {% endif %}

            </nav>
        </div>
    </header>

    <!-- CONTENIDO -->
    <main class="container my-3">
        {% block content %}{% endblock %}
    </main>

    <!-- PIE -->
    <footer class="bg-light text-center mt-4 py-3">
        <small>&copy; Mercadona: Martín Hernández Ruiz 2025-2026</small>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


    <!-- OFFCANVAS - CARRITO -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasCarrito" aria-labelledby="offcanvasCarritoLabel">

        <div class="offcanvas-header">
            <h5 id="offcanvasCarritoLabel">Carro</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>

        <div class="offcanvas-body">

            {% if session.carrito and session.carrito.length > 0 %}

            <ul class="list-group mb-3">
                {% for p in session.carrito %}
                <li class="list-group-item d-flex justify-content-between align-items-center">

                    <div class="d-flex align-items-center">
                        <img src="{{ p.url_img }}" alt="{{ p.texto_1 }}" style="height:50px;" class="me-2">

                        <div>
                            <strong>{{ p.texto_1 }}</strong><br>
                            <span class="text-muted small">{{ p.texto_2 }}</span><br>
                            <span>1 ud.</span>
                        </div>
                    </div>

                    <div class="text-end">

                        {% if p.precio_rebajado and p.precio_rebajado > 0 %}
                        <span class="text-muted text-decoration-line-through">
                            {{ p.precio_euros }} €
                        </span><br>
                        <span class="text-danger fw-bold">
                            {{ p.precio_rebajado }} €
                        </span>
                        {% else %}
                        <span class="fw-bold">{{ p.precio_euros }} €</span>
                        {% endif %}

                        <br>

                        <a href="/eliminar_carrito/{{ p._id }}" class="btn btn-sm btn-outline-danger mt-2">
                            <i class="bi bi-trash"></i> Quitar
                        </a>

                    </div>

                </li>
                {% endfor %}
            </ul>

            <div class="d-flex justify-content-between">
                <strong>Total:</strong>
                <span>
                    {{ session.carrito | sum('precio_rebajado', 'precio_euros') }} €
                </span>
            </div>

            <button class="btn btn-success w-100 mt-3">
                Tramitar pedido
            </button>

            {% else %}
            <p>Tu carrito está vacío.</p>
            {% endif %}

        </div>
    </div>

</body>

</html>